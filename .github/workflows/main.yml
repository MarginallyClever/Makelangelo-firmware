name: PlatformIO CI

on: [push]

jobs:

  matrix_prep:
    # Using a separate job and agent so as to be able to use tools like 'sed' and 'jq'
    runs-on: ubuntu-latest
    # Defining outputs of a job allows for easier consumption and use
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    # Checking out code as the set-matrix step utilizes a file named matrix_includes.json
    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
    # This step is explained more in a following section
    - id: set-matrix
      run: |
        matrix=$((
          echo '['
          sed -n 's/\[env:\(.*\)\]/"\1"/p' platformio.ini | tr '\n' ',' | sed 's/,$/\n/'
          echo "]"
        ))
        echo $matrix
        echo $matrix | jq .
        echo "::set-output name=matrix::$matrix"

  build:
    runs-on: ubuntu-latest
    needs: matrix_prep
    strategy:
      fail-fast: false
      matrix:
        env: ${{fromJson(needs.matrix_prep.outputs.matrix)}}

    steps:
    - run: echo "env to build ${MATRIX_ENV}"
      env:
        MATRIX_ENV: ${{ matrix.env }}
